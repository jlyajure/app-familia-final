<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAMILIA YAJURE - DIAGN√ìSTICO</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; padding: 20px; }
        .card { border: 1px solid gold; margin: 10px; padding: 10px; border-radius: 10px; }
        img { max-width: 100px; border-radius: 5px; }
        #error-log { color: #ff4444; font-weight: bold; background: #222; padding: 10px; display: none; }
        button { padding: 15px; font-size: 16px; background: gold; border: none; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h2 style="text-align:center; color:gold;">MODO DIAGN√ìSTICO üîß</h2>
    
    <div id="status">‚è≥ Intentando conectar con la base de datos...</div>
    <div id="error-log"></div>

    <div id="gallery" style="margin-top:20px;"></div>

    <button onclick="window.triggerAdmin()" style="margin-top:20px;">üëÆ‚Äç‚ôÇÔ∏è MODO DIRECTOR</button>

    <div id="admin-panel" style="display:none; background:#333; padding:20px; position:fixed; top:0; left:0; width:100%; height:100%;">
        <h3>Subir Foto</h3>
        <input type="text" id="up-titulo" placeholder="T√≠tulo" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="file" id="up-file" style="margin-bottom:10px;">
        <button onclick="window.subirFoto()">SUBIR</button>
        <button onclick="location.reload()" style="background:red; margin-top:10px; color:white;">CERRAR</button>
    </div>

<script type="module">
    // üî• IMPORTACIONES B√ÅSICAS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 1. CONFIGURACI√ìN (TUS LLAVES)
    const firebaseConfig = { apiKey: "AIzaSyBwBq4gLgv4DSfUidzUuC7Irmvj_4pCTtI", authDomain: "familia-yajure-app.firebaseapp.com", projectId: "familia-yajure-app", storageBucket: "familia-yajure-app.firebasestorage.app", messagingSenderId: "692035727386", appId: "1:692035727386:web:dfa3e39a481d56368a61a3" };

    try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const IMGBB_KEY = "07dd4f0a1180673510c5047ae8b5eec8";

        document.getElementById('status').innerText = "‚úÖ Firebase Conectado. Buscando fotos en 'familia'...";

        // 2. LEER BASE DE DATOS (SIN ORDENAR PARA EVITAR ERRORES)
        // üî• IMPORTANTE: Aqu√≠ uso la colecci√≥n "familia"
        onSnapshot(collection(db, "familia"), (snap) => {
            const galeria = document.getElementById('gallery');
            galeria.innerHTML = "";
            
            if (snap.empty) {
                document.getElementById('status').innerText = "‚ö†Ô∏è Conectado, pero la carpeta 'familia' est√° VAC√çA o no existe.";
            } else {
                document.getElementById('status').innerText = "üéâ ¬°FOTOS ENCONTRADAS! (" + snap.size + ")";
                
                snap.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = "card";
                    item.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${data.titulo || "Sin t√≠tulo"}</strong>
                            <button onclick="window.borrar('${doc.id}')" style="width:30px; height:30px; padding:0; background:red; color:white;">üóëÔ∏è</button>
                        </div>
                        <br>
                        <img src="${data.imagenUrl}" width="100%">
                    `;
                    galeria.appendChild(item);
                });
            }
        }, (error) => {
            // SI FALLA, MUESTRA ESTO EN ROJO
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerText = "‚ùå ERROR DE LECTURA: " + error.message;
        });

        // FUNCIONES SIMPLES
        window.triggerAdmin = () => {
            if(prompt("Clave:") === "ticoadmin2026") document.getElementById('admin-panel').style.display = "block";
        };

        window.subirFoto = async () => {
            const file = document.getElementById('up-file').files[0];
            const titulo = document.getElementById('up-titulo').value;
            if(!file) return alert("Falta foto");

            const formData = new FormData(); formData.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
            const json = await res.json();
            
            await addDoc(collection(db, "familia"), {
                titulo: titulo,
                imagenUrl: json.data.url
            });
            alert("Subida!");
            location.reload();
        };

        window.borrar = async (id) => {
            if(confirm("Borrar?")) await deleteDoc(doc(db, "familia", id));
        };

    } catch (e) {
        document.getElementById('error-log').style.display = 'block';
        document.getElementById('error-log').innerText = "üíÄ ERROR CR√çTICO: " + e.message;
    }
</script>
</body>
</html>
